import React, { useState, useRef, useEffect } from 'react';
import ReactMarkdown from "react-markdown";
import { 
  Send, 
  Upload, 
  User, 
  Bot as BotIcon,
  Briefcase,
  MapPin,
  DollarSign,
  Calendar,
  Building,
  Mail,
  Globe,
  Star,
  CheckCircle,
  AlertCircle
} from 'lucide-react';
import logo from "../assests/valian-tek-logo.jpg";


const Bot = () => {
  const [messages, setMessages] = useState([
    {
      id: 1,
      text: "ðŸ¤–ðŸŽ‰ Welcome to ValiantTek Job Bot Assistance! I'm here to help you find the perfect up-to-date active job opportunities. You can ask me about Software Skills, Roles, Contract / Fulltime jobs, Location based job recommendations. [Note] - Must mention the job role while searching with date or location.",
      sender: 'bot',
      timestamp: new Date()
    }
  ]);
  const [inputText, setInputText] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [uploadedFile, setUploadedFile] = useState(null);
  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (file && (file.type === 'application/pdf' || file.type.includes('document'))) {
      setUploadedFile(file);
      // Add confirmation message
      const newMessage = {
        id: Date.now(),
        text: `ðŸ“„ Resume uploaded successfully: ${file.name}`,
        sender: 'system',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, newMessage]);
    } else {
      alert('Please upload a PDF or document file for your resume.');
    }
  };

  const sendMessageToLLM = async (message, file = null) => {
  try {
    const response = await fetch("http://127.0.0.1:8000/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    const data = await response.json();
    return [{ text: data.reply || "No response from bot." }];
  } catch (error) {
    console.error("Error sending message to LLM:", error);
    return [{
      text: "âŒ Sorry, I can't connect to the job assistant server.",
      sender: "bot"
    }];
  }
};
const fetchJobs = async (query) => {
  try {
    const response = await fetch(`http://127.0.0.1:8000/jobs/search?query=${encodeURIComponent(query)}`);
    const data = await response.json();

    if (data.results && data.results.length > 0) {
      // Format ALL jobs into a single response
      const jobText = 
` ðŸš€ **Showing Related matches** ðŸ”ŽðŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${data.results.map((job) => `
ðŸŒŸ **${job.title}**   
âž¡ï¸ **Company:** ${job.company}  
âž¡ï¸ **Location:** ${job.location}  
âž¡ï¸ **Job Type:** ${job.job_type}  
âž¡ï¸ **Salary:** ${job.salary}  
âž¡ï¸ **Posted On:** ${job.posted}  
âž¡ï¸ **Skills Required:** ${job.skills_required || "Not Provided"}  
âž¡ï¸ **Experience Required:** ${job.experience_required || "Not Provided"}  
âž¡ï¸ **Company Website:** ${job.company_website ? `[Visit Website](${job.company_website})` : "Not Available"}  
âž¡ï¸ **Apply Link:** ${job.apply_link ? `[Apply Here](${job.apply_link})` : "Not Available"}  
âž¡ï¸ **HR Email:** ${job.hr_email}  
âž¡ï¸ **HR Contact:** ${job.hr_contact}  
`).join("\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n")}
`;

      return [{
        id: Date.now(),
        text: jobText,
        sender: "bot",
        timestamp: new Date()
      }];
    } else {
      return [{
        id: Date.now(),
        text: "âš ï¸ No jobs found for your query.",
        sender: "bot",
        timestamp: new Date()
      }];
    }
  } catch (err) {
    console.error("Error fetching jobs:", err);
    return [{
      id: Date.now(),
      text: "âŒ Failed to fetch jobs. Please try again.",
      sender: "bot",
      timestamp: new Date()
    }];
  }
};


  const handleSendMessage = async () => {
  if (!inputText.trim() && !uploadedFile) return;

  const userMessage = {
    id: Date.now(),
    text: inputText,
    sender: 'user',
    timestamp: new Date(),
    hasFile: !!uploadedFile
  };

  setMessages(prev => [...prev, userMessage]);
  setInputText('');
  setIsTyping(true);

  let responses = [];

  // ðŸ”¥ Keywords for job search
  const jobKeywords = [
    "job", "jobs", "developer", "engineer", "analyst", "designer", "manager",
    "intern", "hiring", "vacancy", "opening",
    "python", "java", "react", "node", "aws", "ml", "ai", "data", "sql", "cloud", "devops","job", "jobs", "developer", "engineer", "analyst", "designer", "manager",
  "intern", "hiring", "vacancy", "opening", "company", "posted", "date"
  ];

  // If query matches job keywords â†’ fetch jobs
  if (jobKeywords.some(word => inputText.toLowerCase().includes(word))) {
    responses = await fetchJobs(inputText);
  } else {
    // Otherwise â†’ talk to bot
    responses = await sendMessageToLLM(inputText, uploadedFile);
  }

  // Add bot responses with typing delay
  setTimeout(() => {
    responses.forEach((response, index) => {
      setTimeout(() => {
        const botMessage = {
          id: Date.now() + index,
          text: response.text || "I received your message!",
          sender: 'bot',
          timestamp: new Date()
        };
        setMessages(prev => [...prev, botMessage]);
      }, index * 500);
    });
    setIsTyping(false);
  }, 1000);

  // Reset file upload input
  setUploadedFile(null);
  if (fileInputRef.current) {
    fileInputRef.current.value = '';
  }
};




  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  const formatMessageWithIcons = (text) => {
    // Replace emojis with corresponding Lucide icons
   const iconMap = {
  'ðŸ¢': React.createElement(Building, { className: "inline w-4 h-4 text-red-600" }),
  'ðŸ“': React.createElement(MapPin, { className: "inline w-4 h-4 text-maroon" }),
  'ðŸ’¼': React.createElement(Briefcase, { className: "inline w-4 h-4 text-blue-600" }), // âœ… Job Type
  'ðŸ’²': React.createElement(DollarSign, { className: "inline w-4 h-4 text-red-600" }),
  'ðŸ“…': React.createElement(Calendar, { className: "inline w-4 h-4 text-dark-gray" }),
  'ðŸ”—': React.createElement(Globe, { className: "inline w-4 h-4 text-red-600" }),
  'ðŸ“©': React.createElement(Mail, { className: "inline w-4 h-4 text-maroon" }),
  'â­': React.createElement(Star, { className: "inline w-4 h-4 text-red-600" }),
  'âœ…': React.createElement(CheckCircle, { className: "inline w-4 h-4 text-green-600" }),
  'âŒ': React.createElement(AlertCircle, { className: "inline w-4 h-4 text-red-600" }),
  'ðŸ”': React.createElement(Briefcase, { className: "inline w-4 h-4 text-maroon" })
};


    let formattedText = text;
    Object.entries(iconMap).forEach(([emoji, icon]) => {
      const parts = formattedText.split(emoji);
      if (parts.length > 1) {
        formattedText = parts.map((part, index) => {
          if (index < parts.length - 1) {
            return part + ' ';
          }
          return part;
        }).join('');
      }
    });

    return formattedText;
  };

  return React.createElement('div', {
    style: {
      width: '100%',
      maxWidth: '420px',
      height: '600px',
      background: 'linear-gradient(135deg, #FCFCFC 0%, #E0DDD5 100%)',
      fontFamily: 'system-ui, -apple-system, sans-serif',
      borderRadius: '16px',
      boxShadow: '0 8px 32px rgba(130, 13, 13, 0.15)',
      overflow: 'hidden',
      display: 'flex',
      flexDirection: 'column',
      margin: '0 auto'
    }
  }, [
    // Header
    React.createElement('div', {
      key: 'header',
      style: {
        background: 'linear-gradient(135deg, #215bea 0%, #366bec 100%)',
        color: '#FCFCFC',
        padding: '12px 16px',
        textAlign: 'center',
        boxShadow: '0 2px 10px rgba(130, 13, 13, 0.3)'
      }
    }, [
      React.createElement('div', {
        key: 'header-content',
        style: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '8px',
          marginBottom: '4px'
        }
      }, [
        React.createElement('img', {
          key: 'logo',
          src: logo,
          alt: 'Valian Tek Logo',
          style: { 
            width: '20px', 
            height: '20px', 
            animation: 'pulse 2s infinite' 
          }
        }),
        React.createElement('h1', {
          key: 'title',
          style: {
            fontSize: '16px',
            fontWeight: 'bold',
            margin: 0,
            textShadow: '1px 1px 2px rgba(0,0,0,0.3)'
          }
        }, 'ValiantTek Job Assistant')
      ]),
      React.createElement('p', {
        key: 'subtitle',
        style: {
          margin: 0,
          opacity: 0.9,
          fontSize: '12px'
        }
      }, 'Your AI career companion')
    ]),

    // Messages Area
    React.createElement('div', {
      key: 'messages',
      style: {
        flex: 1,
        backgroundColor: '#FCFCFC',
        padding: '12px',
        overflowY: 'auto',
        display: 'flex',
        flexDirection: 'column'
      }
    }, [
      ...messages.map((message) =>
        React.createElement('div', {
          key: message.id,
          style: {
            display: 'flex',
            alignItems: 'flex-start',
            gap: '8px',
            marginBottom: '12px',
            justifyContent: message.sender === 'user' ? 'flex-end' : 'flex-start'
          }
        }, [
          message.sender !== 'user' && React.createElement('div', {
            key: 'avatar',
            style: {
              backgroundColor: message.sender === 'bot' ? '#007AFF' : '#898580',
              borderRadius: '50%',
              padding: '4px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              minWidth: '24px',
              minHeight: '24px'
            }
          }, React.createElement(message.sender === 'bot' ? BotIcon : AlertCircle, {
            size: 14,
            color: '#FCFCFC'
          })),
          
          React.createElement('div', {
            key: 'message-content',
            style: {
              maxWidth: '75%',
              backgroundColor: message.sender === 'user' ? '#007aff' : 
                              message.sender === 'bot' ? '#E0DDD5' : '#898580',
              color: message.sender === 'user' ? '#FCFCFC' : '#656565',
              padding: '8px 12px',
              borderRadius: message.sender === 'user' ? '12px 12px 2px 12px' : '12px 12px 12px 2px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
              animation: 'slideIn 0.3s ease-out',
              fontSize: '13px',
              lineHeight: '1.4'
            }
          }, [
            React.createElement(ReactMarkdown, {
                key: 'text',
                children: formatMessageWithIcons(message.text),
                components: {
                    strong: ({node, ...props}) => 
                    React.createElement('span', { style: { fontWeight: 'bold', color: 'gray' } }, props.children),
                    a: ({node, ...props}) => 
                    React.createElement('a', { ...props, style: { color: '#007AFF', wordBreak: "break-word" }, target: "_blank", rel: "noopener noreferrer" })
                }
                }),
            message.hasFile && React.createElement('div', {
              key: 'file-indicator',
              style: {
                marginTop: '4px',
                fontSize: '10px',
                opacity: 0.8,
                display: 'flex',
                alignItems: 'center',
                gap: '2px'
              }
            }, [
              React.createElement(Upload, { key: 'upload-icon', size: 10 }),
              'Resume attached'
            ]),
            React.createElement('div', {
              key: 'timestamp',
              style: {
                fontSize: '9px',
                opacity: 0.6,
                marginTop: '4px',
                textAlign: 'right'
              }
            }, message.timestamp.toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit'
            }))
          ]),
          
          message.sender === 'user' && React.createElement('div', {
            key: 'user-avatar',
            style: {
              backgroundColor: '#1d5bdfff',
              borderRadius: '50%',
              padding: '4px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              minWidth: '24px',
              minHeight: '24px'
            }
          }, React.createElement(User, { size: 14, color: '#FCFCFC' }))
        ])
      ),
      
      isTyping && React.createElement('div', {
        key: 'typing',
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          marginBottom: '12px'
        }
      }, [
        React.createElement('div', {
          key: 'bot-avatar',
          style: {
            backgroundColor: '#007AFF',
            borderRadius: '50%',
            padding: '4px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            minWidth: '24px',
            minHeight: '24px'
          }
        }, React.createElement(BotIcon, { size: 14, color: '#FCFCFC' })),
        React.createElement('div', {
          key: 'typing-indicator',
          style: {
            backgroundColor: '#E0DDD5',
            padding: '8px 12px',
            borderRadius: '12px 12px 12px 2px',
            display: 'flex',
            alignItems: 'center',
            gap: '4px'
          }
        }, [
          React.createElement('div', {
            key: 'dots',
            style: {
              display: 'flex',
              gap: '2px'
            }
          }, [0, 1, 2].map((i) =>
            React.createElement('div', {
              key: i,
              style: {
                width: '4px',
                height: '4px',
                borderRadius: '50%',
                backgroundColor: '#898580',
                animation: `typing 1.4s infinite ${i * 0.2}s`
              }
            })
          )),
          React.createElement('span', {
            key: 'typing-text',
            style: { color: '#656565', fontSize: '11px' }
          }, 'Typing...')
        ])
      ]),
      React.createElement('div', { key: 'messages-end', ref: messagesEndRef })
    ]),

    // Input Area
    React.createElement('div', {
      key: 'input-area',
      style: {
        backgroundColor: '#FCFCFC',
        borderTop: '1px solid #E0DDD5',
        padding: '12px'
      }
    }, [
      uploadedFile && React.createElement('div', {
        key: 'uploaded-file',
        style: {
          backgroundColor: '#E0DDD5',
          padding: '6px 8px',
          borderRadius: '8px',
          marginBottom: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          fontSize: '11px'
        }
      }, [
        React.createElement('div', {
          key: 'file-info',
          style: {
            display: 'flex',
            alignItems: 'center',
            gap: '4px',
            color: '#656565'
          }
        }, [
          React.createElement(Upload, { key: 'upload-icon', size: 12 }),
          React.createElement('span', { key: 'filename' }, uploadedFile.name)
        ]),
        React.createElement('button', {
          key: 'remove-file',
          onClick: () => {
            setUploadedFile(null);
            if (fileInputRef.current) {
              fileInputRef.current.value = '';
            }
          },
          style: {
            background: 'none',
            border: 'none',
            color: '#D40000',
            cursor: 'pointer',
            fontSize: '14px',
            padding: '2px'
          }
        }, 'Ã—')
      ]),

      React.createElement('div', {
        key: 'input-row',
        style: {
          display: 'flex',
          gap: '8px',
          alignItems: 'center'
        }
      }, [
        React.createElement('div', {
          key: 'textarea-container',
          style: { flex: 1 }
        }, React.createElement('textarea', {
          value: inputText,
          onChange: (e) => setInputText(e.target.value),
          onKeyPress: handleKeyPress,
          placeholder: 'Type your message here...',
          style: {
            width: '100%',
            height: '36px',
            maxHeight: '80px',
            padding: '8px 10px',
            border: '1px solid #E0DDD5',
            borderRadius: '8px',
            fontSize: '13px',
            fontFamily: 'inherit',
            resize: 'none',
            outline: 'none',
            backgroundColor: '#FCFCFC',
            color: '#656565',
            boxSizing: 'border-box'
          },
          onFocus: (e) => {
            e.target.style.borderColor = '#007AFF';
          },
          onBlur: (e) => {
            e.target.style.borderColor = '#E0DDD5';
          }
        })),

        React.createElement('input', {
          key: 'file-input',
          type: 'file',
          ref: fileInputRef,
          onChange: handleFileUpload,
          accept: '.pdf,.doc,.docx',
          style: { display: 'none' }
        }),

        

        React.createElement('button', {
          key: 'send-button',
          onClick: handleSendMessage,
          disabled: !inputText.trim() && !uploadedFile,
          style: {
            background: 'linear-gradient(135deg, #007AFF 0%, #00A3FF 100%)',
            border: 'none',
            borderRadius: '8px',
            padding: '8px',
            cursor: (!inputText.trim() && !uploadedFile) ? 'not-allowed' : 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            minWidth: '36px',
            height: '36px',
            opacity: (!inputText.trim() && !uploadedFile) ? 0.5 : 1
          },
          title: 'Send Message'
        }, React.createElement(Send, { size: 16, color: '#FCFCFC' }))
      ])
    ]),

    // Styles
    React.createElement('style', {
      key: 'styles'
    }, `
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes typing {
        0%, 60%, 100% {
          transform: scale(1);
          opacity: 0.5;
        }
        30% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
      
      ::-webkit-scrollbar {
        width: 4px;
      }
      
      ::-webkit-scrollbar-track {
        background: #E0DDD5;
        border-radius: 2px;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #898580;
        border-radius: 2px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #656565;
      }

      @media (max-width: 480px) {
        .chatbot-container {
          width: 100%;
          height: 100vh;
          border-radius: 0;
        }
      }
    `)
  ]);
};

export default Bot;
